<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>First Game</title>
	<style>
		* {
			box-sizing: border-box;
		}

		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			background-color: #000;
			color: #fff;
			font-family: Arial, sans-serif;
			overflow: hidden;
		}

		body {
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			touch-action: none;
		}

		#game-container {
			width: 640px;
			height: 360px;
			max-width: 90vw;
			max-height: 60vh;
			border: 2px solid #444;
			box-shadow: 0 0 10px #222;
			background: #111;
			position: relative;
		}

		canvas {
			width: 100%;
			height: 100%;
			display: block;
			image-rendering: pixelated;
			outline: none;
		}

		#status {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(36, 36, 36, 0.85);
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			visibility: hidden;
			z-index: 10;
		}

		#status-splash {
			max-width: 80%;
			max-height: 60%;
			margin-bottom: 1rem;
		}

		#status-progress {
			width: 60%;
			height: 10px;
			border-radius: 5px;
			overflow: hidden;
			background-color: #444;
			display: none;
		}

		#status-progress::-webkit-progress-bar {
			background-color: #444;
		}

		#status-progress::-webkit-progress-value {
			background-color: #66cc66;
		}

		#status-notice {
			display: none;
			margin-top: 1rem;
			background-color: #5b3943;
			border: 1px solid #9b3943;
			border-radius: 8px;
			padding: 1rem;
			color: #e0e0e0;
			text-align: center;
			max-width: 80%;
		}
	</style>
</head>
<body>
	<div id="game-container">
		<canvas id="canvas">Your browser does not support the canvas tag.</canvas>

		<div id="status">
			<img id="status-splash" src="index.png" alt="Loading" class="show-image--true fullsize--true use-filter--true">
			<progress id="status-progress"></progress>
			<div id="status-notice"></div>
		</div>
	</div>

	<noscript>Your browser does not support JavaScript.</noscript>

	<script src="index.js"></script>
	<script>
		const GODOT_CONFIG = {
			"args": [],
			"canvasResizePolicy": 2,
			"ensureCrossOriginIsolationHeaders": true,
			"executable": "index",
			"experimentalVK": false,
			"fileSizes": {
				"index.pck": 7839984,
				"index.wasm": 52126319
			},
			"focusCanvas": true,
			"gdextensionLibs": []
		};

		const GODOT_THREADS_ENABLED = false;
		const engine = new Engine(GODOT_CONFIG);

		(function () {
			const statusOverlay = document.getElementById('status');
			const statusProgress = document.getElementById('status-progress');
			const statusNotice = document.getElementById('status-notice');

			let initializing = true;
			let statusMode = '';

			function setStatusMode(mode) {
				if (statusMode === mode || !initializing) return;

				if (mode === 'hidden') {
					statusOverlay.remove();
					initializing = false;
					return;
				}
				statusOverlay.style.visibility = 'visible';
				statusProgress.style.display = (mode === 'progress') ? 'block' : 'none';
				statusNotice.style.display = (mode === 'notice') ? 'block' : 'none';
				statusMode = mode;
			}

			function setStatusNotice(text) {
				statusNotice.innerHTML = text.replace(/\n/g, '<br>');
			}

			function displayFailureNotice(err) {
				console.error(err);
				setStatusNotice(err instanceof Error ? err.message : (typeof err === 'string' ? err : 'An unknown error occurred.'));
				setStatusMode('notice');
				initializing = false;
			}

			const missing = Engine.getMissingFeatures({ threads: GODOT_THREADS_ENABLED });

			if (missing.length !== 0) {
				if (GODOT_CONFIG.serviceWorker && GODOT_CONFIG.ensureCrossOriginIsolationHeaders && 'serviceWorker' in navigator) {
					let registrationPromise = navigator.serviceWorker.getRegistration().catch(() => null);

					Promise.race([
						registrationPromise.then(reg => {
							if (reg) return Promise.reject('Service worker already exists.');
							return engine.installServiceWorker();
						}),
						new Promise(resolve => setTimeout(resolve, 2000))
					]).then(() => location.reload())
					.catch(err => {
						console.error('Error registering service worker:', err);
					});
				} else {
					displayFailureNotice("Error\nMissing features:\n" + missing.join("\n"));
				}
			} else {
				setStatusMode('progress');
				engine.startGame({
					onProgress: (current, total) => {
						if (current > 0 && total > 0) {
							statusProgress.value = current;
							statusProgress.max = total;
						} else {
							statusProgress.removeAttribute('value');
							statusProgress.removeAttribute('max');
						}
					}
				}).then(() => {
					setStatusMode('hidden');
				}, displayFailureNotice);
			}
		})();
	</script>
</body>
</html>
